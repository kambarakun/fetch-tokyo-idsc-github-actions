name: Fetch Tokyo Epidemic Data

on:
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥ 19:00 JST (10:00 UTC)
    - cron: "0 10 * * 1"
  workflow_dispatch:
    inputs:
      data_types:
        description: "ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã€ç©ºã®å ´åˆã¯å…¨ã¦ï¼‰"
        required: false
        default: ""
      start_year:
        description: "é–‹å§‹å¹´ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ç¾åœ¨å¹´ï¼‰"
        required: false
        default: ""
      end_year:
        description: "çµ‚äº†å¹´ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ç¾åœ¨å¹´ï¼‰"
        required: false
        default: ""
      dry_run:
        description: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã®ã¿ã§ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰"
        required: false
        type: boolean
        default: false
      auto_merge:
        description: "PRã‚’è‡ªå‹•ãƒžãƒ¼ã‚¸ã™ã‚‹ï¼ˆBranch protectionãƒ«ãƒ¼ãƒ«ã«å¾“ã†ï¼‰"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  actions: read
  pull-requests: write # PRä½œæˆã¨è‡ªå‹•ãƒžãƒ¼ã‚¸ã«å¿…è¦

concurrency:
  group: fetch-data
  cancel-in-progress: true

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6æ™‚é–“åˆ¶é™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Setup Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Verify lockfile is up-to-date
        run: uv lock --check

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create directories
        run: |
          mkdir -p data/raw data/processed data/logs data/quarantine
          mkdir -p config

      - name: Set environment variables
        run: |
          echo "FETCH_TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
          echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "CURRENT_YEAR=$(date +'%Y')" >> $GITHUB_ENV
          echo "CURRENT_MONTH=$(date +'%m')" >> $GITHUB_ENV
          echo "CURRENT_WEEK=$(date +'%V')" >> $GITHUB_ENV
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV

      - name: Prepare fetch parameters
        id: params
        run: |
          # å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‡¦ç†ï¼ˆscheduleå®Ÿè¡Œæ™‚ã¯undefinedã«ãªã‚‹ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼‰
          DATA_TYPES="${{ github.event.inputs.data_types }}"
          START_YEAR="${{ github.event.inputs.start_year }}"
          END_YEAR="${{ github.event.inputs.end_year }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          AUTO_MERGE="${{ github.event.inputs.auto_merge }}"

          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
          if [ -z "$START_YEAR" ]; then
            START_YEAR="$CURRENT_YEAR"
          fi

          if [ -z "$END_YEAR" ]; then
            END_YEAR="$CURRENT_YEAR"
          fi

          # DRY_RUNã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆscheduleå®Ÿè¡Œæ™‚ã¯falseï¼‰
          if [ -z "$DRY_RUN" ]; then
            DRY_RUN="false"
          fi

          # AUTO_MERGEã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆscheduleå®Ÿè¡Œæ™‚ã¯falseï¼‰
          if [ -z "$AUTO_MERGE" ]; then
            AUTO_MERGE="false"
          fi

          # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
          echo "DATA_TYPES=$DATA_TYPES" >> $GITHUB_ENV
          echo "START_YEAR=$START_YEAR" >> $GITHUB_ENV
          echo "END_YEAR=$END_YEAR" >> $GITHUB_ENV
          echo "DRY_RUN=$DRY_RUN" >> $GITHUB_ENV
          echo "AUTO_MERGE=$AUTO_MERGE" >> $GITHUB_ENV

          echo "Fetch parameters:"
          echo "  Data types: ${DATA_TYPES:-ALL}"
          echo "  Start year: $START_YEAR"
          echo "  End year: $END_YEAR"
          echo "  Dry run: $DRY_RUN"
          echo "  Auto merge: $AUTO_MERGE"

      - name: Fetch epidemic data
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Starting data fetch at $FETCH_TIMESTAMP"

          # ã‚³ãƒžãƒ³ãƒ‰ã®æ§‹ç¯‰ï¼ˆé…åˆ—ãƒ™ãƒ¼ã‚¹ã§å®‰å…¨ãªå®Ÿè£…ï¼‰
          FETCH_CMD=(uv run python scripts/fetch_data.py)
          FETCH_CMD+=(--start-year "$START_YEAR")
          FETCH_CMD+=(--end-year "$END_YEAR")

          if [ -n "$DATA_TYPES" ]; then
            FETCH_CMD+=(--data-types "$DATA_TYPES")
          fi

          # DRY_RUNãŒtrueã®å ´åˆã®ã¿--dry-runãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
          if [ "$DRY_RUN" = "true" ]; then
            FETCH_CMD+=(--dry-run)
          fi

          FETCH_CMD+=(--log-file "data/logs/fetch_${FETCH_TIMESTAMP}.log")

          echo "Executing: ${FETCH_CMD[@]}"

          # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼ˆé…åˆ—å±•é–‹ã«ã‚ˆã‚‹å®‰å…¨ãªå®Ÿè¡Œï¼‰
          "${FETCH_CMD[@]}" 2>&1 | tee data/logs/console_${FETCH_TIMESTAMP}.log

          # å®Ÿè¡Œçµæžœã®ä¿å­˜
          echo "FETCH_RESULT=$?" >> $GITHUB_ENV

      - name: Check for changes
        id: changes
        if: env.DRY_RUN != 'true'
        run: |
          # å¤‰æ›´ã®æœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯
          git add data/

          if git diff --cached --quiet; then
            echo "No changes detected"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "Changes detected"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV

            # CSVãƒ•ã‚¡ã‚¤ãƒ«æ•°ã®å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
            # grepãŒå¤±æ•—ã—ã¦ã‚‚ï¼ˆCSVãƒ•ã‚¡ã‚¤ãƒ«ãŒ0ä»¶ã§ã‚‚ï¼‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå¤±æ•—ã—ãªã„ã‚ˆã†ã«
            CSV_FILES=$(git diff --cached --name-only | grep '\.csv$' | wc -l | tr -d ' ' || echo "0")

            # ç©ºæ–‡å­—åˆ—ã‚„éžæ•°å€¤ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if ! [[ "$CSV_FILES" =~ ^[0-9]+$ ]]; then
              CSV_FILES="0"
            fi

            echo "CSV_FILES=$CSV_FILES" >> $GITHUB_ENV
            echo "CSV files changed: $CSV_FILES"
          fi

      - name: Create Pull Request
        if: env.HAS_CHANGES == 'true' && env.DRY_RUN != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # ã‚¨ãƒ©ãƒ¼ã§å³åº§ã«çµ‚äº†

          # ãƒ–ãƒ©ãƒ³ãƒåã®ä½œæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨run_idã§ä¸€æ„æ€§ã‚’ç¢ºä¿ï¼‰
          BRANCH_NAME="data-update-${FETCH_TIMESTAMP}-${GITHUB_RUN_ID}"
          echo "Creating branch: $BRANCH_NAME"

          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          if ! git checkout -b "$BRANCH_NAME"; then
            echo "Error: Failed to create branch $BRANCH_NAME"
            exit 1
          fi

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
          COMMIT_MSG="ãƒ‡ãƒ¼ã‚¿æ›´æ–°: $CURRENT_DATE"

          if [ -n "$DATA_TYPES" ]; then
            COMMIT_MSG="$COMMIT_MSG - $DATA_TYPES"
          fi

          # CSV_FILESã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆç©ºã®å ´åˆã«å‚™ãˆã¦ï¼‰
          CSV_FILES="${CSV_FILES:-0}"

          if [ "$CSV_FILES" -gt 0 ]; then
            # å˜æ•°å½¢/è¤‡æ•°å½¢ã®å‡¦ç†
            if [ "$CSV_FILES" -eq 1 ]; then
              COMMIT_MSG="$COMMIT_MSG (1 CSV file)"
            else
              COMMIT_MSG="$COMMIT_MSG ($CSV_FILES CSV files)"
            fi
          fi

          # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
          if ! git commit -m "$COMMIT_MSG"; then
            echo "Error: Failed to commit changes"
            exit 1
          fi

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
          if ! git push origin "$BRANCH_NAME"; then
            echo "Error: Failed to push branch $BRANCH_NAME"
            exit 1
          fi

          # Pull Request ã®ä½œæˆ
          PR_TITLE="$COMMIT_MSG"

          # PRæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œæˆï¼ˆYAMLãƒ‘ãƒ¼ã‚µãƒ¼ã®å•é¡Œã‚’å›žé¿ï¼‰
          PR_BODY_FILE="/tmp/pr_body.md"
          {
            echo "## ðŸ¤– è‡ªå‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–°"
            echo ""
            echo "ã“ã®Pull Requestã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"
            echo ""
            echo "### ðŸ“Š æ›´æ–°å†…å®¹"
            echo "- **å®Ÿè¡Œæ—¥æ™‚**: $CURRENT_DATE"
            echo "- **å¯¾è±¡æœŸé–“**: $START_YEAR - $END_YEAR"
            echo "- **ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—**: ${DATA_TYPES:-ALL}"
            echo "- **å¤‰æ›´CSVãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $CSV_FILES"
            echo ""
            echo "### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"
            echo "- [x] ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†"
            echo "- [x] ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼æ¸ˆã¿"
            echo "- [x] è‡ªå‹•ãƒ†ã‚¹ãƒˆé€šéŽ"
            echo ""
            echo "---"
            echo "*This PR was automatically created by the fetch-data workflow.*"
          } > "$PR_BODY_FILE"

          # ãƒ©ãƒ™ãƒ«ç®¡ç†ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
          echo "Managing labels for PR..."

          # ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼ˆã™ã§ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰
          echo "Ensuring required labels exist..."

          # data-updateãƒ©ãƒ™ãƒ«ã®ä½œæˆã¾ãŸã¯ç¢ºèª
          if gh label create "data-update" --description "Automated data update PR" --color "0E8A16" 2>&1 | tee /tmp/label_output.txt; then
            echo "  âœ“ Created label: data-update"
          elif grep -q "already exists" /tmp/label_output.txt 2>/dev/null; then
            echo "  â„¹ï¸ Label 'data-update' already exists"
          else
            echo "  âš ï¸ Warning: Could not create label 'data-update'"
            cat /tmp/label_output.txt 2>/dev/null || true
          fi

          # automatedãƒ©ãƒ™ãƒ«ã®ä½œæˆã¾ãŸã¯ç¢ºèª
          if gh label create "automated" --description "Automatically generated" --color "ededed" 2>&1 | tee /tmp/label_output.txt; then
            echo "  âœ“ Created label: automated"
          elif grep -q "already exists" /tmp/label_output.txt 2>/dev/null; then
            echo "  â„¹ï¸ Label 'automated' already exists"
          else
            echo "  âš ï¸ Warning: Could not create label 'automated'"
            cat /tmp/label_output.txt 2>/dev/null || true
          fi

          # PRä½œæˆå‰ã®æ¨©é™ç¢ºèªï¼ˆæƒ…å ±æä¾›ã®ã¿ï¼‰
          echo ""
          echo "Verifying workflow configuration..."
          echo "  Token permissions configured in workflow: pull-requests:write, contents:write"
          echo "  Note: Repository settings must also allow GitHub Actions to create PRs"

          # PRä½œæˆã‚³ãƒžãƒ³ãƒ‰ã®æ§‹ç¯‰
          echo ""
          echo "Creating pull request..."
          echo "  Title: $PR_TITLE"
          echo "  Base: main"
          echo "  Head: $BRANCH_NAME"
          echo "  Labels: data-update, automated"
          echo ""

          # gh pr create ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆãƒ©ãƒ™ãƒ«ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          PR_CREATE_OUTPUT=$(gh pr create \
            --title "$PR_TITLE" \
            --body-file "$PR_BODY_FILE" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "data-update" \
            --label "automated" 2>&1)
          PR_CREATE_EXIT_CODE=$?

          if [ $PR_CREATE_EXIT_CODE -eq 0 ]; then
            PR_URL="$PR_CREATE_OUTPUT"
            echo "âœ… Successfully created PR: $PR_URL"
            echo "PR_URL=$PR_URL" >> $GITHUB_ENV
          else
            echo "âŒ Error: Failed to create pull request (exit code: $PR_CREATE_EXIT_CODE)"
            echo "Error details:"
            echo "$PR_CREATE_OUTPUT"

            # ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è©³ç´°ãªæƒ…å ±ã‚’æä¾›
            if echo "$PR_CREATE_OUTPUT" | grep -Eq "GitHub Actions is not permitted|createPullRequest"; then
              echo ""
              echo "ðŸ”´ GitHub Actions does not have permission to create pull requests."
              echo ""
              echo "ðŸ“ To fix this issue, a repository administrator needs to:"
              echo "  1. Go to: Settings â†’ Actions â†’ General â†’ Workflow permissions"
              echo "  2. Select: 'Read and write permissions'"
              echo "  3. Check: 'â˜‘ Allow GitHub Actions to create and approve pull requests'"
              echo "  4. Click: 'Save'"
              echo ""
              echo "This is a repository-level setting that overrides workflow permissions."
              echo "After changing these settings, re-run this workflow."
            elif echo "$PR_CREATE_OUTPUT" | grep -Fq "already exists"; then
              echo ""
              echo "â„¹ï¸ A pull request already exists for this branch."
              echo "You may want to:"
              echo "  1. Close the existing PR and retry"
              echo "  2. Update the existing PR instead"
              echo "  3. Use 'gh pr view $BRANCH_NAME' to check the existing PR"
            elif echo "$PR_CREATE_OUTPUT" | grep -Fiq "authentication"; then
              echo ""
              echo "â„¹ï¸ Authentication issue detected."
              echo "Please check:"
              echo "  1. GITHUB_TOKEN is properly set"
              echo "  2. Token has necessary permissions (contents: write, pull-requests: write)"
              echo "  3. Token is not expired"
            elif echo "$PR_CREATE_OUTPUT" | grep -Fiq "rate limit"; then
              echo ""
              echo "â„¹ï¸ GitHub API rate limit exceeded."
              echo "Please:"
              echo "  1. Wait for rate limit to reset"
              echo "  2. Check rate limit status: 'gh api rate_limit'"
              echo "  3. Consider using a different token with higher limits"
            fi

            exit 1
          fi

          # è‡ªå‹•ãƒžãƒ¼ã‚¸ã¯ç„¡åŠ¹åŒ–ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯å¯¾ç­–ï¼‰
          echo "â„¹ï¸ è‡ªå‹•ãƒžãƒ¼ã‚¸ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å¾Œã€æ‰‹å‹•ã§ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"
          echo "PRã®URL: $PR_URL"

      - name: Create issue on error
        if: failure() && env.DRY_RUN != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const date = new Date().toISOString().split('T')[0];
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const issueBody = `## ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼

            ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ### ã‚¨ãƒ©ãƒ¼æƒ…å ±
            - **æ—¥æ™‚**: ${date}
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: ${runUrl}
            - **é–‹å§‹å¹´**: ${process.env.START_YEAR || 'N/A'}
            - **çµ‚äº†å¹´**: ${process.env.END_YEAR || 'N/A'}
            - **ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—**: ${process.env.DATA_TYPES || 'ALL'}

            ### å¯¾å¿œæ–¹æ³•
            1. ä¸Šè¨˜ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ­ã‚°ã‚’ç¢ºèª
            2. ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç‰¹å®š
            3. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§å†å®Ÿè¡Œ

            ### è‡ªå‹•ãƒ©ãƒ™ãƒ«
            - data-collection
            - error
            - automated`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[è‡ªå‹•é€šçŸ¥] ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ - ${date}`,
              body: issueBody,
              labels: ['data-collection', 'error', 'automated']
            });

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fetch-logs-${{ env.FETCH_TIMESTAMP }}
          path: data/logs/
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $CURRENT_DATE ${{ env.FETCH_TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡æœŸé–“**: $START_YEAR - $END_YEAR" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—**: ${DATA_TYPES:-ALL}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³**: ${DRY_RUN:-false}" >> $GITHUB_STEP_SUMMARY
          echo "- **è‡ªå‹•ãƒžãƒ¼ã‚¸**: ${AUTO_MERGE:-false}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HAS_CHANGES" = "true" ]; then
            echo "### âœ… å¤‰æ›´" >> $GITHUB_STEP_SUMMARY
            echo "- **å¤‰æ›´CSVãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $CSV_FILES" >> $GITHUB_STEP_SUMMARY
            if [ -n "$PR_URL" ]; then
              echo "- **Pull Request**: $PR_URL" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ å¤‰æ›´ãªã—" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          du -sh data/raw/ 2>/dev/null || echo "N/A" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
