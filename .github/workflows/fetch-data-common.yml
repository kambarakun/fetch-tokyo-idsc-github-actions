name: Common Data Fetch Workflow

on:
  workflow_call:
    inputs:
      schedule_type:
        description: "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—ï¼ˆdaily ã¾ãŸã¯ weeklyï¼‰"
        required: true
        type: string
      skip_existing:
        description: "æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—"
        required: false
        type: boolean
        default: false
      force_update:
        description: "æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¼·åˆ¶çš„ã«å†å–å¾—"
        required: false
        type: boolean
        default: false
      check_previous_year:
        description: "å‰å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ãƒã‚§ãƒƒã‚¯"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        required: false
        type: boolean
        default: false
      timeout_minutes:
        description: "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆåˆ†ï¼‰"
        required: false
        type: number
        default: 60

permissions:
  contents: write
  issues: write
  actions: read
  pull-requests: write

jobs:
  fetch-and-validate:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Setup Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create directories
        run: |
          mkdir -p data/raw/.metadata data/processed data/logs
          mkdir -p config

      - name: Set environment variables
        run: |
          echo "FETCH_TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
          echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "CURRENT_YEAR=$(date +'%Y')" >> $GITHUB_ENV
          echo "PREVIOUS_YEAR=$(date -d 'last year' +'%Y' 2>/dev/null || date -v-1y +'%Y')" >> $GITHUB_ENV
          echo "CURRENT_MONTH=$(date +'%m')" >> $GITHUB_ENV
          echo "CURRENT_WEEK=$(date +'%V')" >> $GITHUB_ENV
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "SCHEDULE_TYPE=${{ inputs.schedule_type }}" >> $GITHUB_ENV

      - name: Determine fetch parameters
        id: params
        run: |
          # é–‹å§‹å¹´ã®æ±ºå®šï¼ˆundefinedã®å ´åˆã‚‚å®‰å…¨ã«å‡¦ç†ï¼‰
          CHECK_PREV_YEAR="${{ inputs.check_previous_year }}"
          SCHEDULE_TYPE="${{ inputs.schedule_type }}"

          if [ "${CHECK_PREV_YEAR:-false}" = "true" ] || ([ "$CURRENT_MONTH" = "01" ] && [ "${SCHEDULE_TYPE:-}" = "weekly" ]); then
            START_YEAR="$PREVIOUS_YEAR"
            echo "ðŸ“… Including previous year data: $PREVIOUS_YEAR"
            CHECK_PREVIOUS_YEAR="true"
          else
            START_YEAR="$CURRENT_YEAR"
            CHECK_PREVIOUS_YEAR="false"
          fi

          echo "START_YEAR=$START_YEAR" >> $GITHUB_ENV
          echo "END_YEAR=$CURRENT_YEAR" >> $GITHUB_ENV
          echo "CHECK_PREVIOUS_YEAR=$CHECK_PREVIOUS_YEAR" >> $GITHUB_ENV
          echo "SKIP_EXISTING=${{ inputs.skip_existing || false }}" >> $GITHUB_ENV
          echo "FORCE_UPDATE=${{ inputs.force_update || false }}" >> $GITHUB_ENV
          echo "DRY_RUN=${{ inputs.dry_run || false }}" >> $GITHUB_ENV

          echo "Fetch parameters:"
          echo "  Start year: $START_YEAR"
          echo "  End year: $CURRENT_YEAR"
          echo "  Skip existing: ${{ inputs.skip_existing }}"
          echo "  Force update: ${{ inputs.force_update }}"
          echo "  Dry run: ${{ inputs.dry_run }}"

      - name: Validate existing data
        id: validate-before
        run: |
          echo "ãƒ‡ãƒ¼ã‚¿å–å¾—å‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼..."
          if [ -d "data/raw" ] && [ "$(ls -A data/raw/*.csv 2>/dev/null | wc -l)" -gt 0 ]; then
            uv run python scripts/validate_data.py data/raw --pattern "*.csv" || true
          else
            echo "No existing data to validate"
          fi

      - name: Fetch epidemic data
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Starting data fetch at $FETCH_TIMESTAMP"

          # ã‚³ãƒžãƒ³ãƒ‰ã®æ§‹ç¯‰
          FETCH_CMD=(uv run python scripts/fetch_data.py)
          FETCH_CMD+=(--start-year "$START_YEAR")
          FETCH_CMD+=(--end-year "$END_YEAR")

          if [ "${{ inputs.skip_existing || false }}" = "true" ]; then
            FETCH_CMD+=(--skip-existing)
          fi

          if [ "${{ inputs.force_update || false }}" = "true" ]; then
            FETCH_CMD+=(--force-update)
          fi

          if [ "${{ inputs.dry_run || false }}" = "true" ]; then
            FETCH_CMD+=(--dry-run)
          fi

          FETCH_CMD+=(--log-file "data/logs/${SCHEDULE_TYPE}_${FETCH_TIMESTAMP}.log")

          echo "Executing: ${FETCH_CMD[@]}"

          # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
          "${FETCH_CMD[@]}" 2>&1 | tee data/logs/console_${SCHEDULE_TYPE}_${FETCH_TIMESTAMP}.log

          # å®Ÿè¡Œçµæžœã®ä¿å­˜
          echo "FETCH_RESULT=$?" >> $GITHUB_ENV

      - name: Validate fetched data
        id: validate-after
        if: ${{ inputs.dry_run != true }}
        run: |
          echo "å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼..."
          VALIDATION_REPORT="data/logs/validation_${FETCH_TIMESTAMP}.json"

          if uv run python scripts/validate_data.py data/raw --pattern "*.csv" --output "$VALIDATION_REPORT"; then
            echo "âœ… ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼æˆåŠŸ"
            echo "VALIDATION_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å¤±æ•—"
            echo "VALIDATION_SUCCESS=false" >> $GITHUB_ENV

            # æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆã®å†…å®¹ã‚’è¡¨ç¤º
            if [ -f "$VALIDATION_REPORT" ]; then
              echo "æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ:"
              cat "$VALIDATION_REPORT" | python -m json.tool | head -50
            fi
          fi

      - name: Check for changes
        id: changes
        if: ${{ inputs.dry_run != true }}
        run: |
          git add data/

          if git diff --cached --quiet; then
            echo "No changes detected"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "Changes detected"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV

            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã®å–å¾—
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            NEW_FILES=$(git diff --cached --name-only --diff-filter=A | wc -l)
            MODIFIED_FILES=$(git diff --cached --name-only --diff-filter=M | wc -l)

            echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV
            echo "NEW_FILES=$NEW_FILES" >> $GITHUB_ENV
            echo "MODIFIED_FILES=$MODIFIED_FILES" >> $GITHUB_ENV

            echo "Summary:"
            echo "  Total changed: $CHANGED_FILES"
            echo "  New files: $NEW_FILES"
            echo "  Modified files: $MODIFIED_FILES"
          fi

      - name: Create Pull Request
        if: ${{ env.HAS_CHANGES == 'true' && inputs.dry_run != true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # ãƒ–ãƒ©ãƒ³ãƒåã®ä½œæˆ
          BRANCH_NAME="data-update-${SCHEDULE_TYPE}-${FETCH_TIMESTAMP}-${GITHUB_RUN_ID}"
          echo "Creating branch: $BRANCH_NAME"

          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          git checkout -b "$BRANCH_NAME"

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
          if [ "$SCHEDULE_TYPE" = "daily" ]; then
            COMMIT_MSG="ãƒ‡ãƒ¼ã‚¿æ›´æ–°: $CURRENT_DATE ($CHANGED_FILES files)"
            PR_TITLE="$COMMIT_MSG"
            LABEL_PREFIX="daily"
          else
            COMMIT_MSG="é€±æ¬¡ãƒ‡ãƒ¼ã‚¿æ›´æ–°: $CURRENT_DATE (ç¬¬${CURRENT_WEEK}é€±)"
            if [ "$CHANGED_FILES" -gt 0 ]; then
              COMMIT_MSG="$COMMIT_MSG - å¤‰æ›´${CHANGED_FILES}ä»¶"
              if [ "$NEW_FILES" -gt 0 ] && [ "$MODIFIED_FILES" -gt 0 ]; then
                COMMIT_MSG="$COMMIT_MSG (æ–°è¦${NEW_FILES}ä»¶/æ›´æ–°${MODIFIED_FILES}ä»¶)"
              elif [ "$NEW_FILES" -gt 0 ]; then
                COMMIT_MSG="$COMMIT_MSG (æ–°è¦${NEW_FILES}ä»¶)"
              elif [ "$MODIFIED_FILES" -gt 0 ]; then
                COMMIT_MSG="$COMMIT_MSG (æ›´æ–°${MODIFIED_FILES}ä»¶)"
              fi
            fi
            PR_TITLE="$COMMIT_MSG"
            LABEL_PREFIX="weekly"
          fi

          # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
          git commit -m "$COMMIT_MSG"

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
          git push origin "$BRANCH_NAME"

          # PRæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œæˆ
          PR_BODY_FILE="/tmp/pr_body.md"
          {
            echo "## ðŸ¤– è‡ªå‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–° ($SCHEDULE_TYPE)"
            echo ""
            echo "ã“ã®Pull Requestã¯${SCHEDULE_TYPE}ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"
            echo ""
            echo "### ðŸ“Š æ›´æ–°å†…å®¹"
            echo "- **å®Ÿè¡Œæ—¥æ™‚**: $CURRENT_DATE"
            echo "- **ãƒã‚§ãƒƒã‚¯ã‚¿ã‚¤ãƒ—**: ${SCHEDULE_TYPE}ãƒã‚§ãƒƒã‚¯"
            echo "- **å¯¾è±¡æœŸé–“**: $START_YEAR - $END_YEAR"
            if [ "$SCHEDULE_TYPE" = "weekly" ]; then
              echo "- **ç¾åœ¨ã®é€±**: ç¬¬${CURRENT_WEEK}é€±"
            fi
            echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $CHANGED_FILES"
            if [ "$NEW_FILES" -gt 0 ]; then
              echo "  - æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: $NEW_FILES"
            fi
            if [ "$MODIFIED_FILES" -gt 0 ]; then
              echo "  - æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«: $MODIFIED_FILES"
            fi
            echo ""

            if [ "$CHECK_PREVIOUS_YEAR" = "true" ]; then
              echo "### ðŸ“… å‰å¹´ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯"
              echo "å‰å¹´ï¼ˆ${PREVIOUS_YEAR}å¹´ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ç¢ºèªã—ã¾ã—ãŸã€‚"
              echo ""
            fi

            echo "### âœ… ãƒã‚§ãƒƒã‚¯å†…å®¹"
            echo "- [x] ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†"
            if [ "$VALIDATION_SUCCESS" = "true" ]; then
              echo "- [x] ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ âœ…"
            else
              echo "- [ ] ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ âŒ **è¦ç¢ºèª**"
            fi
            echo ""

            if [ "$VALIDATION_SUCCESS" = "false" ]; then
              echo "### âš ï¸ è­¦å‘Š"
              echo "ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒžãƒ¼ã‚¸å‰ã«æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
              echo ""
            fi

            echo "### ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"
            echo "- è‡ªå‹•ãƒžãƒ¼ã‚¸ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™"
            echo "- ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè£…æ¸ˆã¿"
            echo "- ãƒžãƒ¼ã‚¸å‰ã«æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™"
            echo ""

            echo "---"
            echo "*This PR was automatically created by the ${SCHEDULE_TYPE} check workflow.*"
          } > "$PR_BODY_FILE"

          # ãƒ©ãƒ™ãƒ«ç®¡ç†
          echo "Managing labels for PR..."

          # ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆæ—¢å­˜ã®å ´åˆã¯ç„¡è¦–ï¼‰
          gh label create "${LABEL_PREFIX}-update" --description "${SCHEDULE_TYPE^} automated data check" --color "0075CA" 2>/dev/null || true
          gh label create "data-update" --description "Automated data update PR" --color "0E8A16" 2>/dev/null || true
          gh label create "automated" --description "Automatically generated" --color "ededed" 2>/dev/null || true

          if [ "$VALIDATION_SUCCESS" = "false" ]; then
            gh label create "needs-review" --description "Requires manual review" --color "d73a4a" 2>/dev/null || true
            EXTRA_LABEL="--label needs-review"
          else
            EXTRA_LABEL=""
          fi

          # PRä½œæˆ
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body-file "$PR_BODY_FILE" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "${LABEL_PREFIX}-update" \
            --label "data-update" \
            --label "automated" \
            $EXTRA_LABEL)

          echo "âœ… Successfully created PR: $PR_URL"
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      - name: Create issue on error
        if: ${{ failure() && inputs.dry_run != true }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const date = new Date().toISOString().split('T')[0];
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const issueBody = `## ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ (${process.env.SCHEDULE_TYPE})

            ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ### ã‚¨ãƒ©ãƒ¼æƒ…å ±
            - **æ—¥æ™‚**: ${date}
            - **ã‚¿ã‚¤ãƒ—**: ${process.env.SCHEDULE_TYPE}
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: ${runUrl}
            - **é–‹å§‹å¹´**: ${process.env.START_YEAR || 'N/A'}
            - **çµ‚äº†å¹´**: ${process.env.END_YEAR || 'N/A'}

            ### å¯¾å¿œæ–¹æ³•
            1. ä¸Šè¨˜ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ­ã‚°ã‚’ç¢ºèª
            2. ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç‰¹å®š
            3. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§å†å®Ÿè¡Œ

            ### è‡ªå‹•ãƒ©ãƒ™ãƒ«
            - ${process.env.SCHEDULE_TYPE}-check
            - data-collection
            - error
            - automated`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[${process.env.SCHEDULE_TYPE}ãƒã‚§ãƒƒã‚¯] ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ - ${date}`,
              body: issueBody,
              labels: [`${process.env.SCHEDULE_TYPE}-check`, 'data-collection', 'error', 'automated']
            });

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.schedule_type }}-check-logs-${{ env.FETCH_TIMESTAMP }}
          path: data/logs/
          retention-days: ${{ inputs.schedule_type == 'daily' && 7 || 30 }}

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ã‚µãƒžãƒªãƒ¼ (${SCHEDULE_TYPE})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $CURRENT_DATE ${{ env.FETCH_TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒ—**: ${SCHEDULE_TYPE}ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡æœŸé–“**: $START_YEAR - $END_YEAR" >> $GITHUB_STEP_SUMMARY
          if [ "$SCHEDULE_TYPE" = "weekly" ]; then
            echo "- **ç¾åœ¨ã®é€±**: ç¬¬${CURRENT_WEEK}é€±" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³**: ${DRY_RUN:-false}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HAS_CHANGES" = "true" ]; then
            echo "### âœ… å¤‰æ›´æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
            echo "- **ç·å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
            if [ -n "$NEW_FILES" ] && [ "$NEW_FILES" -gt 0 ]; then
              echo "- **æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: $NEW_FILES" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$MODIFIED_FILES" ] && [ "$MODIFIED_FILES" -gt 0 ]; then
              echo "- **æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«**: $MODIFIED_FILES" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$PR_URL" ]; then
              echo "- **Pull Request**: $PR_URL" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$VALIDATION_SUCCESS" = "false" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âš ï¸ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
              echo "ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚PRã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ å¤‰æ›´ãªã—" >> $GITHUB_STEP_SUMMARY
            echo "${SCHEDULE_TYPE}ãƒã‚§ãƒƒã‚¯ã§å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi
