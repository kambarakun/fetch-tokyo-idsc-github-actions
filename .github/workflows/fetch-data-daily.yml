name: ðŸ“… æ¯Žæ—¥ãƒ‡ãƒ¼ã‚¿ç°¡æ˜“ãƒã‚§ãƒƒã‚¯

on:
  schedule:
    # æ¯Žæ—¥ 17:00 JST (08:00 UTC) ã«å®Ÿè¡Œ
    # æœ¨æ›œå¤•æ–¹ã®æ›´æ–°ã‚’ç¢ºå®Ÿã«ã‚­ãƒ£ãƒƒãƒ
    - cron: "0 8 * * *"
  workflow_dispatch:
    inputs:
      skip_existing:
        description: "æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰"
        required: false
        type: boolean
        default: true
      dry_run:
        description: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã®ã¿ã§ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  actions: read
  pull-requests: write

concurrency:
  # æ—¥æ¬¡ã¨é€±æ¬¡ã§åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å…±æœ‰ã—ã€ãƒ‡ãƒ¼ã‚¿ç«¶åˆã‚’é˜²ã
  group: fetch-data
  # æ—¢å­˜ã®å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„ï¼ˆãƒ‡ãƒ¼ã‚¿æ¬ è½ã‚’é˜²ãï¼‰
  cancel-in-progress: false

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # æ¯Žæ—¥å®Ÿè¡Œãªã®ã§çŸ­ã‚ã«è¨­å®š

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Setup Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create directories
        run: |
          mkdir -p data/raw/.metadata data/processed data/logs
          mkdir -p config

      - name: Set environment variables
        run: |
          echo "FETCH_TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
          echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "CURRENT_YEAR=$(date +'%Y')" >> $GITHUB_ENV
          echo "CURRENT_MONTH=$(date +'%m')" >> $GITHUB_ENV
          echo "CURRENT_WEEK=$(date +'%V')" >> $GITHUB_ENV
          echo "PREVIOUS_WEEK=$(date -d 'last week' +'%V')" >> $GITHUB_ENV
          echo "PREVIOUS_MONTH=$(date -d 'last month' +'%m')" >> $GITHUB_ENV
          echo "CURRENT_DAY=$(date +'%u')" >> $GITHUB_ENV
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV

      - name: Prepare fetch parameters
        id: params
        run: |
          # å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‡¦ç†
          SKIP_EXISTING="${{ github.event.inputs.skip_existing }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®šï¼ˆscheduleå®Ÿè¡Œæ™‚ï¼‰
          if [ -z "$SKIP_EXISTING" ]; then
            SKIP_EXISTING="true"  # æ¯Žæ—¥å®Ÿè¡Œãªã®ã§æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
          fi

          if [ -z "$DRY_RUN" ]; then
            DRY_RUN="false"
          fi

          # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
          echo "SKIP_EXISTING=$SKIP_EXISTING" >> $GITHUB_ENV
          echo "DRY_RUN=$DRY_RUN" >> $GITHUB_ENV

          echo "Daily simple check parameters:"
          echo "  Current year: $CURRENT_YEAR"
          echo "  Current week: $CURRENT_WEEK / Previous week: $PREVIOUS_WEEK"
          echo "  Current month: $CURRENT_MONTH / Previous month: $PREVIOUS_MONTH"
          echo "  Skip existing: $SKIP_EXISTING"
          echo "  Dry run: $DRY_RUN"

      - name: Validate existing data before fetch
        id: validate-before
        run: |
          echo "ãƒ‡ãƒ¼ã‚¿å–å¾—å‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼..."
          if [ -d "data/raw" ] && [ "$(ls -A data/raw/*.csv 2>/dev/null | wc -l)" -gt 0 ]; then
            uv run python scripts/validate_data.py data/raw --pattern "*.csv" || true
          else
            echo "No existing data to validate"
          fi

      - name: Fetch epidemic data (recent weeks and months only)
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Starting daily simple data check at $FETCH_TIMESTAMP"

          # ã‚³ãƒžãƒ³ãƒ‰ã®æ§‹ç¯‰ï¼ˆé€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã¨æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’å¯¾è±¡é€±ãƒ»æœˆã‚’çµžã£ã¦å–å¾—ï¼‰
          FETCH_CMD=(uv run python scripts/fetch_data.py)
          FETCH_CMD+=(--start-year "$CURRENT_YEAR")
          FETCH_CMD+=(--end-year "$CURRENT_YEAR")

          # å¯¾è±¡é€±ã‚’æœ€æ–°é€±ã¨å‰é€±ã«é™å®š
          FETCH_CMD+=(--target-weeks "$PREVIOUS_WEEK,$CURRENT_WEEK")

          # å¯¾è±¡æœˆã‚’å½“æœˆã¨å‰æœˆã«é™å®š
          FETCH_CMD+=(--target-months "$PREVIOUS_MONTH,$CURRENT_MONTH")

          # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆ
          if [ "$SKIP_EXISTING" = "true" ]; then
            FETCH_CMD+=(--skip-existing)
          fi

          # DRY_RUNãŒtrueã®å ´åˆ
          if [ "$DRY_RUN" = "true" ]; then
            FETCH_CMD+=(--dry-run)
          fi

          FETCH_CMD+=(--log-file "data/logs/daily_${FETCH_TIMESTAMP}.log")

          echo "Executing: ${FETCH_CMD[@]}"
          echo "Checking weeks: $PREVIOUS_WEEK, $CURRENT_WEEK"
          echo "Checking months: $PREVIOUS_MONTH, $CURRENT_MONTH"

          # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
          "${FETCH_CMD[@]}" 2>&1 | tee data/logs/console_daily_${FETCH_TIMESTAMP}.log

          # å®Ÿè¡Œçµæžœã®ä¿å­˜
          echo "FETCH_RESULT=$?" >> $GITHUB_ENV

      - name: Check for changes
        id: changes
        if: env.DRY_RUN != 'true'
        run: |
          # å¤‰æ›´ã®æœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯
          git add data/

          if git diff --cached --quiet; then
            echo "No new data found today"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "New data found!"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV

            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã®å–å¾—
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV
            echo "Changed files: $CHANGED_FILES"

            # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            echo "New files detected:"
            git diff --cached --name-only --diff-filter=A
          fi

      - name: Create Pull Request
        if: env.HAS_CHANGES == 'true' && env.DRY_RUN != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # ãƒ–ãƒ©ãƒ³ãƒåã®ä½œæˆ
          BRANCH_NAME="data-update-daily-${FETCH_TIMESTAMP}-${GITHUB_RUN_ID}"
          echo "Creating branch: $BRANCH_NAME"

          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          git checkout -b "$BRANCH_NAME"

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
          COMMIT_MSG="ãƒ‡ãƒ¼ã‚¿æ›´æ–°: $CURRENT_DATE"

          if [ "$CHANGED_FILES" -gt 0 ]; then
            COMMIT_MSG="$COMMIT_MSG ($CHANGED_FILES files)"
          fi

          # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
          git commit -m "$COMMIT_MSG"

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
          git push origin "$BRANCH_NAME"

          # Pull Request ã®ä½œæˆ
          PR_TITLE="$COMMIT_MSG"

          # PRæœ¬æ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œæˆ
          PR_BODY_FILE="/tmp/pr_body.md"
          {
            echo "## ðŸ¤– è‡ªå‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–° (æ¯Žæ—¥ç°¡æ˜“ãƒã‚§ãƒƒã‚¯)"
            echo ""
            echo "ã“ã®Pull Requestã¯æ¯Žæ—¥ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚"
            echo ""
            echo "### ðŸ“Š æ›´æ–°å†…å®¹"
            echo "- **å®Ÿè¡Œæ—¥æ™‚**: $CURRENT_DATE"
            echo "- **ãƒã‚§ãƒƒã‚¯ã‚¿ã‚¤ãƒ—**: æ¯Žæ—¥ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€æ–°é€±ï¼‹å‰é€±ã€å½“æœˆï¼‹å‰æœˆï¼‰"
            echo "- **å¯¾è±¡å¹´**: $CURRENT_YEAR"
            echo "- **å¯¾è±¡é€±**: ç¬¬${PREVIOUS_WEEK}é€±, ç¬¬${CURRENT_WEEK}é€±"
            echo "- **å¯¾è±¡æœˆ**: ${PREVIOUS_MONTH}æœˆ, ${CURRENT_MONTH}æœˆ"
            echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $CHANGED_FILES"
            echo ""
            echo "### â„¹ï¸ å‚™è€ƒ"
            echo "æ¯Žæ—¥å®Ÿè¡Œã§ã¯æœ€æ–°é€±ï¼‹å‰é€±ã®é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã¨ã€å½“æœˆï¼‹å‰æœˆã®æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚"
            echo "å…¨ãƒ‡ãƒ¼ã‚¿ã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯ã¯æ¯Žé€±æœ¨æ›œæ—¥ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚"
            echo ""
            echo "---"
            echo "*This PR was automatically created by the daily check workflow.*"
          } > "$PR_BODY_FILE"

          # ãƒ©ãƒ™ãƒ«ç®¡ç†
          echo "Managing labels for PR..."

          # ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆæ—¢å­˜ã®å ´åˆã¯ç„¡è¦–ï¼‰
          gh label create "daily-update" --description "Daily automated data check" --color "0075CA" 2>/dev/null || true
          gh label create "data-update" --description "Automated data update PR" --color "0E8A16" 2>/dev/null || true
          gh label create "automated" --description "Automatically generated" --color "ededed" 2>/dev/null || true

          # PRä½œæˆ
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body-file "$PR_BODY_FILE" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "daily-update" \
            --label "data-update" \
            --label "automated")

          echo "âœ… Successfully created PR: $PR_URL"
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

          # PRç•ªå·ã‚’å–å¾—
          PR_NUMBER=$(echo "$PR_URL" | sed 's/.*\/pull\///')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

          # è‡ªå‹•ãƒžãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–ï¼ˆsquashãƒžãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰
          echo "ðŸ”„ è‡ªå‹•ãƒžãƒ¼ã‚¸ã‚’è¨­å®šä¸­..."
          gh pr merge "$PR_NUMBER" --auto --squash || {
            echo "âš ï¸ è‡ªå‹•ãƒžãƒ¼ã‚¸ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"
          }

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-check-logs-${{ env.FETCH_TIMESTAMP }}
          path: data/logs/
          retention-days: 7 # æ¯Žæ—¥å®Ÿè¡Œãªã®ã§çŸ­ã‚ã«

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š æ¯Žæ—¥ãƒ‡ãƒ¼ã‚¿ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $CURRENT_DATE ${{ env.FETCH_TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ›œæ—¥**: $(date +'%A')" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡å¹´**: $CURRENT_YEAR" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡é€±**: ç¬¬${PREVIOUS_WEEK}é€±, ç¬¬${CURRENT_WEEK}é€±" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡æœˆ**: ${PREVIOUS_MONTH}æœˆ, ${CURRENT_MONTH}æœˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒƒãƒ—**: ${SKIP_EXISTING:-true}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³**: ${DRY_RUN:-false}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HAS_CHANGES" = "true" ]; then
            echo "### âœ… æ–°è¦ãƒ‡ãƒ¼ã‚¿æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
            echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
            if [ -n "$PR_URL" ]; then
              echo "- **Pull Request**: $PR_URL" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ æ–°è¦ãƒ‡ãƒ¼ã‚¿ãªã—" >> $GITHUB_STEP_SUMMARY
            echo "æœ¬æ—¥ã¯æ–°è¦ãƒ‡ãƒ¼ã‚¿ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi
